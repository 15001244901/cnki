(function(){var e={r:function(b){if(e[b].inited)return e[b].value;if("function"===typeof e[b].value){var c={exports:{}},h=e[b].value(null,c.exports,c);e[b].inited=!0;e[b].value=h;if(void 0!==h)return h;for(var a in c.exports)if(c.exports.hasOwnProperty(a))return e[b].inited=!0,e[b].value=c.exports}else return e[b].inited=!0,e[b].value},"0":{value:function(){function b(a,f,d,g){g|=0;if(g>c)return d;g++;h.each(d,function(i,d){a?!i||"object"!==typeof i&&"function"!==typeof i?f[d]=i:(f[d]=f[d]||(h.isArray(i)?
[]:{}),f[d]=b(a,f[d],i,g)):f[d]=i});return f}var c=10,h={extend:function(a,f){var d=!1;"boolean"===typeof a?(d=a,a=f,f=[].splice.call(arguments,2)):f=[].splice.call(arguments,1);if(!a)throw Error("Utils: extend, target can not be empty");h.each(f,function(g){(g&&typeof g==="object"||typeof g==="function")&&b(d,a,g)});return a},contains:function(a,f){if(a.contains)return a.contains(f);if(a.compareDocumentPosition)return!!(a.compareDocumentPosition(f)&16)},getRect:function(a){return a.getBoundingClientRect()},
isArray:function(a){return a&&"[object Array]"==={}.toString.call(a)},isString:function(a){return"string"===typeof a},proxy:function(a,f){return function(){return a.apply(f,arguments)}},each:function(a,f){if(a)if("length"in a&&"number"===typeof a.length)for(var d=0,g=a.length;d<g&&!1!==f.call(null,a[d],d,a);d++);else for(d in a)if(a.hasOwnProperty(d)&&!1===f.call(null,a[d],d,a))break}};return h}},1:{value:function(){return e.r(21).createClass("Component",{constructor:function(){}})}},2:{value:function(){var b=
{},c=0,h=!0,a=e.r(3),f=e.r(0),d=function(a){var d=a.type,c=a.target,e=this.__kfe_eid,q=/^(?:before|after)/.test(d),e=b[e][d];if(!q&&(g.trigger(c,"before"+d),!1===h))return h=!0,!1;f.each(e,function(g){if(g&&!1===g.call(c,a))return h=!1});q||g.trigger(c,"after"+d)},g={addEvent:function(a,g,f){var h=!0,e=null;a.__kfe_eid||(h=!1,a.__kfe_eid=++c,b[a.__kfe_eid]={});e=b[a.__kfe_eid];e[g]||(h=!1,e[g]=[]);e[g].push(f);h||a.addEventListener(g,d,!1)},trigger:function(g,f,d){d=d||a.createEvent(f,d);g.dispatchEvent(d)}};
return g}},3:{value:function(){return{createEvent:function(b){var c=document.createEvent("Event");c.initEvent(b,!0,!0);return c}}}},4:{value:function(){var b={},c=e.r(0);c.extend(b,c,e.r(2));return b}},5:{value:function(){var b=e.r(21),c=e.r(8);return b.createClass("ControllerComponent",{constructor:function(c){this.kfEditor=c;this.components={};this.initComponents()},initComponents:function(){this.components.listener=new c(this,this.kfEditor)}})}},6:{value:function(){var b={32:"\\,","s+219":"\\{",
"s+221":"\\}",220:"\\backslash","s+51":"\\#","s+52":"\\$","s+53":"\\%","s+54":"\\^","s+55":"\\&","s+189":"\\_","s+192":"\\~"};return{getReplaceString:function(c){return b[c]||null}}}},7:{value:function(){var b=e.r(21),c=e.r(4),h=e.r(37),a=h.cursorCharacter,f=e.r(6),d={"，":",","。":".","；":";","）":")","（":"("};return b.createClass("InputComponent",{constructor:function(a,i){this.parentComponent=a;this.kfEditor=i;this.latexMode=!1;this.latexInput=null;this.inputBox=this.createInputBox();this.initServices();
this.initCommands();this.initEvent()},initServices:function(){this.kfEditor.registerService("control.update.input",this,{updateInput:this.updateInput});this.kfEditor.registerService("control.insert.string",this,{insertStr:this.insertStr});this.kfEditor.registerService("control.update.latex.mode",this,{updateLatexMode:this.updateLatexMode});this.kfEditor.registerService("control.set.source",this,{setSource:this.setSource})},initCommands:function(){this.kfEditor.registerCommand("reset",this,this.reset);
this.kfEditor.registerCommand("focus",this,this.focus);this.kfEditor.registerCommand("get.source",this,this.getSource)},reset:function(){this.kfEditor.requestService("render.draw","\\placeholder");this.kfEditor.requestService("ui.update.canvas.view");this.kfEditor.requestService("control.select.all")},createInputBox:function(){this.kfEditor.getContainer();var a=this.kfEditor.getDocument().createElement("input");a.className="kf-editor-input-box";a.type="text";a.isTrusted=!1;a.style.cssText="position: fixed;top: 0;left: -99999999px;";
top.document.body.appendChild(a);return a},focus:function(){var a=null;this.inputBox.focus();a=this.kfEditor.requestService("syntax.get.root.group.info");this.kfEditor.requestService("syntax.update.record.cursor",{groupId:a.id,startOffset:0,endOffset:a.content.length});this.kfEditor.requestService("control.update.input");this.kfEditor.requestService("control.reselect");this.kfEditor.requestService("ui.toolbar.enable")},getSource:function(){return this.latexInput.value.replace(/\\placeholder/g,"")},
setSource:function(a){this.latexInput.value=a},updateLatexMode:function(a){this.latexMode=!!a},setUntrusted:function(){this.inputBox.isTrusted=!1},setTrusted:function(){this.inputBox.isTrusted=!0},updateInput:function(){var a=this.kfEditor.requestService("syntax.serialization"),i=this.latexMode;this.setUntrusted();this.inputBox.value=a.str;this.inputBox.selectionStart=a.startOffset;this.inputBox.selectionEnd=a.endOffset;this.inputBox.focus();this.setTrusted();this.latexMode=i;this.updateLatex()},
insertStr:function(g){var i=null,d=null,f=i=null,g=" "+g+" ";this.latexInput===this.kfEditor.getDocument().activeElement?(this.latexInput.setRangeText(g),i=this.latexInput.value):(f=this.kfEditor.requestService("syntax.serialization"),i=f.str,d=i.substring(0,f.startOffset),i=i.substring(f.endOffset),-1!==g.indexOf("\\placeholder")&&(d=d.replace(a,"").replace(a,""),i=i.replace(a,"").replace(a,""),g=g.replace("\\placeholder","{"+a+"\\placeholder"+a+"}")),i=d+g+i);this.restruct(i);this.updateInput();
this.kfEditor.requestService("ui.update.canvas.view")},updateLatex:function(){h.enableLatex&&(this.latexInput.value=this.inputBox.value.replace(a,"").replace(a,""),this.latexMode&&this.latexInput.focus())},initEvent:function(){var g=this;c.addEvent(this.inputBox,"keydown",function(a){var d=!1;if(a.ctrlKey)g.processUserCtrl(a);else{switch(a.keyCode){case 229:return;case 37:a.preventDefault();g.leftMove();d=!0;break;case 39:a.preventDefault();g.rightMove();d=!0;break;case 8:a.preventDefault();g.deleteUnit();
d=!0;break;case 13:a.preventDefault(),g.newLine(),d=!0}d&&g.kfEditor.requestService("ui.update.canvas.view");g.pretreatmentInput(a)||a.preventDefault()}});c.addEvent(this.inputBox,"input",function(){try{g.processingInput()}catch(a){}});c.addEvent(this.inputBox,"blur",function(){g.kfEditor.requestService("ui.toolbar.disable");g.kfEditor.requestService("ui.toolbar.close");g.kfEditor.requestService("control.cursor.hide");g.kfEditor.requestService("render.clear.select")});c.addEvent(this.inputBox,"focus",
function(){this.latexInput||(this.latexInput=g.kfEditor.requestService("ui.get.latex.input"));g.updateLatexMode(!1);g.latexInput.value=this.value.replace(a,"").replace(a,"");g.kfEditor.requestService("ui.toolbar.enable");this.isTrusted&&g.kfEditor.requestService("control.reselect")});h.enableLatex&&(this.latexInput||(this.latexInput=g.kfEditor.requestService("ui.get.latex.input")),c.addEvent(this.latexInput,"focus",function(){g.kfEditor.requestService("ui.toolbar.enable");g.updateLatexMode(true)}),
c.addEvent(this.latexInput,"blur",function(){g.updateLatexMode(false);g.kfEditor.requestService("ui.toolbar.disable");g.kfEditor.requestService("ui.toolbar.close")}),c.addEvent(this.latexInput,"input",function(){try{g.kfEditor.requestService("render.draw",this.value);g.kfEditor.requestService("ui.update.canvas.view")}catch(a){}}));c.addEvent(this.inputBox,"paste",function(a){a.preventDefault()})},hasRootplaceholder:function(){return this.kfEditor.requestService("syntax.has.root.placeholder")},leftMove:function(){this.hasRootplaceholder()||
(this.kfEditor.requestService("syntax.cursor.move.left"),this.update())},rightMove:function(){this.hasRootplaceholder()||(this.kfEditor.requestService("syntax.cursor.move.right"),this.update())},deleteUnit:function(){var a=null;this.hasRootplaceholder()||((a=this.kfEditor.requestService("syntax.delete.group"))?(this.updateInput(),this.processingInput()):(this.updateInput(),this.kfEditor.requestService("control.reselect")))},newLine:function(){for(var g=null,d=null,f=0,d=/\\begin\{([^}]+)\}[\s\S]*?\\end\{\1\}/gi,
c=null,b=null,h=this.kfEditor.requestService("syntax.serialization").str;(g=d.exec(h))&&!(f=g.index,c=g[1],g=g[0],-1!==g.indexOf(a)););if(g){for(var d=h.substring(f,g.length+f),d=d.replace("\\begin{"+c+"}","").replace("\\end{"+c+"}",""),d=d.split("\\\\"),e=0,b=d.length;e<b;e++)if(-1!==d[e].indexOf(a)){if("split"===c)d[e]=d[e].replace(a,"").replace(a,""),d.splice(e+1,0,"&{"+a+" \\placeholder "+a+"}");else{b=d[e];d[e]=d[e].replace(a,"").replace(a,"");for(var b=b.split("&"),l=0,o=b.length;l<o;l++)b[l]=
-1!==b[l].indexOf(a)?a+" \\placeholder "+a:"\\placeholder";d.splice(e+1,0,b.join("&"))}break}d="\\begin{"+c+"}"+d.join("\\\\")+"\\end{"+c+"}";h=h.substring(0,f)+d+h.substring(f+g.length);this.inputBox.value=h;this.inputBox.selectionStart=h.indexOf(a);this.inputBox.selectionEnd=h.lastIndexOf(a);this.processingInput()}},processUserCtrl:function(a){a.preventDefault();switch(a.keyCode){case 65:this.kfEditor.requestService("control.select.all");break;case 83:this.kfEditor.requestService("print.image")}},
pretreatmentInput:function(a){a=this.getKeyCode(a);a=f.getReplaceString(a);if(null===a)return!0;this.insertStr(a);return!1},getKeyCode:function(a){return(a.shiftKey?"s+":"")+a.keyCode},processingInput:function(){var g=this.inputBox.value.replace(/[，。；（）]/g,function(a){return d[a]}),f=this.kfEditor.triggerInputEvent(g);f&&(g=f);this.restruct(g);this.latexInput.value=g.replace(a,"").replace(a,"");this.kfEditor.requestService("ui.update.canvas.view")},restruct:function(a){this.kfEditor.requestService("render.draw",
a);this.kfEditor.requestService("control.reselect")},update:function(){this.updateInput();this.kfEditor.requestService("control.reselect")}})}},8:{value:function(){var b=e.r(21),c=e.r(9),h=e.r(7),a=e.r(10);return b.createClass("MoveComponent",{constructor:function(a,d){this.parentComponent=a;this.kfEditor=d;this.components={};this.initComponents()},initComponents:function(){this.components.location=new c(this,this.kfEditor);this.components.selection=new a(this,this.kfEditor);this.components.input=
new h(this,this.kfEditor)}})}},9:{value:function(){var b=e.r(21);return b.createClass("LocationComponent",{constructor:function(c,b){this.parentComponent=c;this.kfEditor=b;this.paper=this.getPaper();this.cursorShape=this.createCursor();this.initServices();this.initEvent()},getPaper:function(){return this.kfEditor.requestService("render.get.paper")},initServices:function(){this.kfEditor.registerService("control.cursor.relocation",this,{relocationCursor:this.updateCursor});this.kfEditor.registerService("control.cursor.hide",
this,{hideCursor:this.hideCursor});this.kfEditor.registerService("control.reselect",this,{reselect:this.reselect});this.kfEditor.registerService("control.get.cursor.location",this,{getCursorLocation:this.getCursorLocation})},createCursor:function(){var c=(new b.Rect(1,0,0,0)).fill("red");c.setAttr("style","display: none");this.paper.addShape(c);return c},initEvent:function(){var c=this;this.kfEditor.request("ui.canvas.container.event").on("mousedown",function(b){b.preventDefault();c.kfEditor.requestService("control.update.latex.mode",
!1);c.updateCursorInfo(b);c.kfEditor.requestService("control.update.input");c.reselect()})},updateCursorInfo:function(c){var b=null,b=null,a=-1;if(this.kfEditor.requestService("syntax.has.root.placeholder"))return this.kfEditor.requestService("syntax.update.record.cursor",{groupId:this.kfEditor.requestService("syntax.get.root.group.info").id,startOffset:0,endOffset:1}),!1;(b=this.kfEditor.requestService("position.get.wrap",c.target))&&this.kfEditor.requestService("syntax.is.placeholder.node",b.id)?
(b=this.kfEditor.requestService("position.get.group.info",b),this.kfEditor.requestService("syntax.update.record.cursor",b.group.id,b.index,b.index+1)):(b=this.kfEditor.requestService("position.get.group",c.target),null===b&&(b=this.kfEditor.requestService("syntax.get.root.group.info")),a=this.getIndex(c.clientX,b),this.kfEditor.requestService("syntax.update.record.cursor",b.id,a))},hideCursor:function(){this.cursorShape.setAttr("style","display: none")},reselect:function(){var b=this.kfEditor.requestService("syntax.get.record.cursor"),
h=null;this.hideCursor();this.kfEditor.requestService("syntax.is.select.placeholder")?(h=this.kfEditor.requestService("syntax.get.group.content",b.groupId),this.kfEditor.requestService("render.select.group",h.content[b.startOffset].id)):b.startOffset===b.endOffset?(this.updateCursor(),this.kfEditor.requestService("render.tint.current.cursor")):this.kfEditor.requestService("render.select.current.cursor")},updateCursor:function(){var b=this.kfEditor.requestService("syntax.get.record.cursor");if(b.startOffset!==
b.endOffset)this.hideCursor();else{var h=this.kfEditor.requestService("syntax.get.group.content",b.groupId),a=0===b.endOffset,f=h.content[a?0:b.endOffset-1],b=this.paper.container.node&&this.paper.container.node.getBoundingClientRect(),d=0,f=f&&f.getBoundingClientRect(),g=this.cursorShape.getTransform(this.cursorShape),i=this.kfEditor.requestService("render.get.canvas.zoom"),e=this.paper.getZoom();f?(this.cursorShape.setHeight(f.height/i/e),d=a?f.left-2:f.left+f.width-2,d-=b.left,g.m.e=Math.floor(d/
i/e)+0.5,g.m.f=(f.top-b.top)/i/e,this.cursorShape.setMatrix(g),this.cursorShape.setAttr("style","display: block")):(h=this.kfEditor.requestService("position.get.group.info",h.groupObj),this.kfEditor.requestService("syntax.update.record.cursor",{groupId:h.group.id,startOffset:h.index+1,endOffset:h.index+1}),this.updateCursor())}},getCursorLocation:function(){var b=this.cursorShape.getRenderBox("paper");return{x:b.x,y:b.y}},getIndex:function(b,h){for(var a=-1,f=h.content,d=null,g=f.length-1,d=null;0<=
g;g--)if(a=g,d=(d=f[g])&&d.getBoundingClientRect(),d.left<b){d.left+d.width/2<b&&(a+=1);break}return a}})}},10:{value:function(){var b=e.r(21),c=e.r(4);return b.createClass("SelectionComponent",{constructor:function(b,a){this.parentComponent=b;this.kfEditor=a;this.isMousedown=this.isDrag=!1;this.startPoint={x:-1,y:-1};this.startGroupIsPlaceholder=!1;this.startGroup={};this.initServices();this.initEvent()},initServices:function(){this.kfEditor.registerService("control.select.all",this,{selectAll:this.selectAll})},
initEvent:function(){var b=this.kfEditor.request("ui.canvas.container.event"),a=this;b.on("mousedown",function(b){b.preventDefault();if(a.kfEditor.requestService("syntax.has.root.placeholder"))return!1;a.isMousedown=!0;a.updateStartPoint(b.clientX,b.clientY);a.updateStartGroup()});b.on("mouseup",function(b){b.preventDefault();a.stopUpdateSelection()});b.on("mousemove",function(b){b.preventDefault();a.isDrag?1!==b.which?a.stopUpdateSelection():a.updateSelection(b.target,b.clientX,b.clientY):a.isMousedown&&
10<a.getDistance(b.clientX,b.clientY)&&(a.kfEditor.requestService("control.cursor.hide"),a.startUpdateSelection())});b.on("dblclick",function(b){a.updateSelectionByTarget(b.target)})},getDistance:function(b,a){var f=Math.abs(b-this.startPoint.x),d=Math.abs(a-this.startPoint.y);return Math.max(f,d)},updateStartPoint:function(b,a){this.startPoint.x=b;this.startPoint.y=a},updateStartGroup:function(){var b=this.kfEditor.requestService("syntax.get.record.cursor");this.startGroupIsPlaceholder=this.kfEditor.requestService("syntax.is.select.placeholder");
this.startGroup={groupInfo:this.kfEditor.requestService("syntax.get.group.content",b.groupId),offset:b.startOffset}},startUpdateSelection:function(){this.isDrag=!0;this.isMousedown=!1;this.clearSelection()},stopUpdateSelection:function(){this.isMousedown=this.isDrag=!1;this.kfEditor.requestService("control.update.input")},clearSelection:function(){this.kfEditor.requestService("render.clear.select")},updateSelection:function(b,a){var f=a>this.startPoint.x,d,g,i;i=null;d=!1;i=this.startGroup;d=null;
var e=this.getGroupInof(a,b);if(e.groupInfo.id===i.groupInfo.id)d=e.groupInfo.id,g=i.offset,i=e.offset,this.startGroupIsPlaceholder&&(f?g===i&&(i+=1):g+=1);else if(c.contains(i.groupInfo.groupObj,e.groupInfo.groupObj))d=i.groupInfo.id,g=i.offset,i=this.getIndex(i.groupInfo.groupObj,b,a);else if(c.contains(e.groupInfo.groupObj,i.groupInfo.groupObj))d=e.groupInfo.id,g=this.kfEditor.requestService("position.get.index",e.groupInfo.groupObj,i.groupInfo.groupObj),i=e.offset,f||(g+=1);else{i=this.getCommunityGroup(i.groupInfo,
e.groupInfo);if(i.startOffset===i.endOffset)i.endOffset+=1;else{d=i.group.content[i.endOffset];if(d=this.kfEditor.requestService("position.get.area",d,a))i.endOffset+=1;f||(i.startOffset+=1)}d=i.group.id;g=i.startOffset;i=i.endOffset}this.kfEditor.requestService("syntax.update.record.cursor",d,g,i);this.kfEditor.requestService("control.reselect")},updateSelectionByTarget:function(b){var b=this.kfEditor.requestService("position.get.parent.group",b),a=null,a={};null!==b&&(this.kfEditor.requestService("syntax.is.root.node",
b.id)?this.selectAll():(this.kfEditor.requestService("syntax.is.virtual.node",b.id)?(a=this.kfEditor.requestService("position.get.group.info",b.groupObj),a={groupId:a.group.id,startOffset:a.index,endOffset:a.index+1}):a={groupId:b.id,startOffset:0,endOffset:b.content.length},this.kfEditor.requestService("syntax.update.record.cursor",a),this.kfEditor.requestService("control.reselect"),this.kfEditor.requestService("control.update.input")))},selectAll:function(){var b=this.kfEditor.requestService("syntax.get.root.group.info");
this.kfEditor.requestService("syntax.update.record.cursor",{groupId:b.id,startOffset:0,endOffset:b.content.length});this.kfEditor.requestService("control.reselect");this.kfEditor.requestService("control.update.input")},getGroupInof:function(b,a){var f=this.kfEditor.requestService("position.get.group",a);null===f&&(f=this.kfEditor.requestService("syntax.get.root.group.info"));var d=this.kfEditor.requestService("position.get.location.info",b,f);return{groupInfo:f,offset:d}},getIndex:function(b,a,f){a=
this.kfEditor.requestService("position.get.index",b,a);b=this.kfEditor.requestService("syntax.get.group.content",b.id).content[a];b=c.getRect(b);b.left+b.width/2<f&&(a+=1);return a},getCommunityGroup:function(b,a){for(var f=null,d=b.groupObj,g=null;(f=this.kfEditor.requestService("position.get.group.info",d))&&!(d=f.group.groupObj,c.contains(f.group.groupObj,a.groupObj)););g=f.group.groupObj;return{group:f.group,startOffset:f.index,endOffset:this.kfEditor.requestService("position.get.index",g,a.groupObj)}}})}},
11:{value:function(){return{GROUP:"kf-editor-group",VIRTUAL:"kf-editor-virtual-group"}}},12:{value:function(){function b(a){var b=this.services[a];if(!b)throw Error("KFEditor: not found service, "+a);return b}var c=e.r(21),h=e.r(4),a={formula:{fontsize:50,autoresize:!1},ui:{zoom:!0,maxzoom:2,minzoom:1}},f={},d=e.r(20).ResourceManager,c=c.createClass("KFEditor",{constructor:function(b,d){this.options=h.extend(!0,{},a,d);this.FormulaClass=null;this._readyState=!1;this._callbacks=[];this._readyCount=
0;this.container=b;this.services={};this.commands={};this.initResource()},isReady:function(){return!!this._readyState},triggerReady:function(){for(var a=null;a=this._callbacks.shift();)a.call(this,this)},ready:function(a){this._readyState?a.call(this,this):this._callbacks.push(a)},getContainer:function(){return this.container},getDocument:function(){return this.container.ownerDocument},getFormulaClass:function(){return this.FormulaClass},getOptions:function(){return this.options},initResource:function(){var a=
this;d.ready(function(b){a.FormulaClass=b;a.initComponents();a._readyState=!0;a.triggerReady()},this.options.resource)},onInput:function(a){this.__onViewInputHandler=a},triggerInputEvent:function(a){return!this.__onViewInputHandler?null:this.__onViewInputHandler.call(null,a)},initComponents:function(){var a=this;h.each(f,function(b,d){new b(a,a.options[d])})},requestService:function(a,d){var f=b.call(this,a);return f.service[f.key].apply(f.provider,[].slice.call(arguments,1))},request:function(a){return b.call(this,
a).service},registerService:function(a,b,d){var f=null;for(f in d)d[f]&&d.hasOwnProperty(f)&&(d[f]=h.proxy(d[f],b));this.services[a]={provider:b,key:f,service:d}},registerCommand:function(a,b,d){this.commands[a]={executor:b,execFn:d}},execCommand:function(a,b){var d=this.commands[a];if(!d)throw Error("KFEditor: not found command, "+a);return d.execFn.apply(d.executor,[].slice.call(arguments,1))}});h.extend(c,{registerComponents:function(a,b){f[a]=b}});return c}},13:{value:function(){function b(a,
b){var d=this;this._callbacks=[];this.editor=new h(a,b);this.editor.ready(function(){d._trigger()})}var c=e.r(21),h=e.r(12);b.prototype._trigger=function(){var a=this.editor;c.Utils.each(this._callbacks,function(b){b.call(a,a)})};b.prototype.ready=function(a){this.editor.isReady()?a.call(this.editor,this.editor):this._callbacks.push(a)};return{create:function(a,f){return new b(a,f)}}}},14:{value:function(){return window.FUI}},15:{value:function(){return window.jQuery}},16:{value:function(){return{selectColor:"rgba(42, 106, 189, 0.2)",
allSelectColor:"rgba(42, 106, 189, 0.6)"}}},17:{value:function(){var b=e.r(21),c=e.r(20),h=e.r(19);return b.createClass("PlaceholderExpression",{base:c.CompoundExpression,constructor:function(){this.callBase();this.setFlag("Placeholder");this.label=null;this.box.setAttr("data-type",null);this.setOperator(new h)},setLabel:function(a){this.label=a},getLabel:function(){return this.label},setAttr:function(a,b){"label"===a?this.setLabel(b):(a.label&&(this.setLabel(a.label),delete a.label),this.callBase(a,
b))},select:function(){this.getOperator().select()},selectAll:function(){this.getOperator().selectAll()},unselect:function(){this.getOperator().unselect()}})}},18:{value:function(){var b=e.r(20),c=e.r(16).selectColor,h=e.r(16).allSelectColor;return{ext:function(a){b.PlaceholderExpression=e.r(17);b.Expression.prototype.select=function(){this.box.fill(c)};b.Expression.prototype.selectAll=function(){this.box.fill(h)};b.Expression.prototype.unselect=function(){this.box.fill("transparent")};a.getKFParser().expand({parse:{placeholder:{name:"placeholder",
handler:function(a){delete a.handler;a.operand=[];return a},sign:!1}},reverse:{placeholder:function(){return"\\placeholder "}}})}}}},19:{value:function(){var b=e.r(21),c=e.r(37).rootPlaceholder.color,h=e.r(16).selectColor,a=e.r(16).allSelectColor;return b.createClass("PlaceholderOperator",{base:e.r(20).Operator,constructor:function(){this.opShape=null;this.callBase("Placeholder")},applyOperand:function(){var a=this.parentExpression.getLabel();if(null!==a){var a=(new b.Text(a)).fill(c),d=new b.Group,
g=(new b.Rect(0,0,0,0,7)).stroke(c).fill("transparent"),i=null;a.setFontSize(40);d.addShape(g);d.addShape(a);this.addOperatorShape(d);i=a.getFixRenderBox();g.stroke(c).fill("transparent");g.setSize(i.width+40,i.height+40);g.setRadius(7);g.setAttr("stroke-dasharray","5, 5");a.setAttr({dx:0-i.x,dy:0-i.y});a.translate(20,20);a=g}else a=null,a=(new b.Rect(35,50,0,0)).stroke("black").fill("transparent"),a.setAttr("stroke-dasharray","5, 5"),this.addOperatorShape(a);this.opShape=a;this.parentExpression.expand(20,
20);this.parentExpression.translateElement(10,10)},select:function(){this.opShape.fill(h)},selectAll:function(){this.opShape.fill(a)},unselect:function(){this.opShape.fill("transparent")}})}},20:{value:function(){return window.kf}},21:{value:function(){return window.kity}},22:{value:function(){return window.KF_UI_CONFIG}},23:{value:function(){return{VIEW_STATE:{NO_OVERFLOW:0,OVERFLOW:1},scrollbar:{step:50,thumbMinSize:50}}}},24:{value:function(){return{DETACHED:1,OVERLAP:2}}},25:{value:function(){return{DRAPDOWN_BOX:1,
AREA:2,DELIMITER:3}}},26:{value:function(){return{BIG:1,SMALL:2}}},27:{value:function(){function b(a,b,d){a=a.createElement(b);a.className=l+d;"thumb"===d&&(d=l+d,a.innerHTML='<div class="$1"></div><div class="$2"></div>'.replace("$1",d+"-left").replace("$2",d+"-right"));return a}function c(a){j.addEvent(a,"mousedown",function(a){a.preventDefault()})}function c(a){j.addEvent(a.container,"mousedown",function(a){a.preventDefault()})}function h(a){j.addEvent(a.widgets.track,"mousedown",function(b){var d=
this.getBoundingClientRect(),f=a.values,i=f.viewWidth/(f.contentWidth-f.viewWidth)*f.trackWidth;b.clientX-d.left>f.offset?f.offset+i>f.trackWidth?g(a,f.trackWidth):g(a,f.offset+i):0>f.offset-i?g(a,0):g(a,f.offset-i)})}function a(a){j.addEvent(a.widgets.leftButton,"mousedown",function(){d(a,-q.step)});j.addEvent(a.widgets.rightButton,"mousedown",function(){d(a,q.step)})}function f(a){var b=!1,d=0,g=0,f=a.values.trackWidth;j.addEvent(a.widgets.thumb,"mousedown",function(f){f.preventDefault();f.stopPropagation();
b=!0;d=f.clientX;g=a.thumbLocationX});j.addEvent(a.container.ownerDocument,"mouseup",function(){b=!1;g=d=0});j.addEvent(a.container.ownerDocument,"mousemove",function(i){if(b){var i=g+(i.clientX-d),c=a.values.thumbWidth;0>i?i=0:i+c>f&&(i=f-c);c=a.values;a.updateOffset(Math.floor(i/(c.trackWidth-c.thumbWidth)*c.trackWidth));a.thumbLocationX=i;a.widgets.thumb.style.left=i+"px"}})}function d(a,b){var d=a.leftOverflow+b;0>d?d=0:d>a.values.scrollWidth&&(d=a.values.scrollWidth);p(a,d)}function g(a,b){var d=
a.values,g=0,g=Math.floor(b/d.trackWidth*(d.trackWidth-d.thumbWidth));0>b&&(g=b=0);a.updateOffset(b);a.widgets.thumb.style.left=g+"px";a.thumbLocationX=g}function i(a,b){var d=a.values,f=0,f=0,f=b/(d.contentWidth-d.viewWidth),f=Math.floor(f*d.trackWidth);g(a,f)}function p(a,b){var d=a.values;g(a,b/(d.contentWidth-d.viewWidth)*d.trackWidth)}var k=e.r(21),n=e.r(23).scrollbar,q=e.r(37).scrollbar,j=e.r(4),l="kf-editor-ui-";return k.createClass("Scrollbar",{constructor:function(a,b){this.uiComponent=a;
this.kfEditor=b;this.widgets=null;this.container=this.uiComponent.scrollbarContainer;this.state=!1;this.values={offset:0,left:0,viewWidth:0,contentWidth:0,trackWidth:0,thumbWidth:0,scrollWidth:0};this.rightOverflow=this.leftOverflow=this.thumbLocationX=0;this.isExpand=!0;this.initWidget();this.mountWidget();this.initSize();this.hide();this.initServices();this.initEvent();this.updateHandler=function(){}},initWidget:function(){var a=this.container.ownerDocument;this.widgets={leftButton:b(a,"div","left-button"),
rightButton:b(a,"div","right-button"),track:b(a,"div","track"),thumb:b(a,"div","thumb"),thumbBody:b(a,"div","thumb-body")}},initSize:function(){var a=this.widgets.leftButton.getBoundingClientRect().width,b=this.widgets.rightButton.getBoundingClientRect().width;this.values.viewWidth=this.container.getBoundingClientRect().width;this.values.trackWidth=this.values.viewWidth-a-b;this.widgets.track.style.width=this.values.trackWidth+"px"},initServices:function(){this.kfEditor.registerService("ui.show.scrollbar",
this,{showScrollbar:this.show});this.kfEditor.registerService("ui.hide.scrollbar",this,{hideScrollbar:this.hide});this.kfEditor.registerService("ui.update.scrollbar",this,{updateScrollbar:this.update});this.kfEditor.registerService("ui.set.scrollbar.update.handler",this,{setUpdateHandler:this.setUpdateHandler});this.kfEditor.registerService("ui.relocation.scrollbar",this,{relocation:this.relocation})},initEvent:function(){c(this);h(this);f(this);a(this)},mountWidget:function(){var a=this.widgets,
b=this.container,d;for(d in a)a.hasOwnProperty(d)&&b.appendChild(a[d]);a.thumb.appendChild(a.thumbBody);a.track.appendChild(a.thumb)},show:function(){this.state=!0;this.container.style.display="block"},hide:function(){this.state=!1;this.container.style.display="none"},update:function(a){var b=this.values.trackWidth,d=0;this.isExpand=a>this.values.contentWidth;this.values.contentWidth=a;this.values.scrollWidth=a-this.values.viewWidth;b>=a?this.hide():(d=Math.max(Math.ceil(b*b/a),n.thumbMinSize),this.values.thumbWidth=
d,this.widgets.thumb.style.width=d+"px",this.widgets.thumbBody.style.width=d-10+"px")},setUpdateHandler:function(a){this.updateHandler=a},updateOffset:function(a){var b=this.values;b.offset=a;b.left=a/b.trackWidth;this.leftOverflow=b.left*(b.contentWidth-b.viewWidth);this.rightOverflow=b.contentWidth-b.viewWidth-this.leftOverflow;this.updateHandler(b.left,b.offset,b)},relocation:function(){var a=this.kfEditor.requestService("control.get.cursor.location"),b=q.padding,d=this.values.contentWidth,g=this.values.viewWidth,
f=this.values.left*(d-g),c=0;a.x<f?(0>a.x&&(a.x=0),i(this,a.x)):a.x+b>f+g?(a.x+=b,a.x>d&&(a.x=d),c=a.x-g,i(this,c)):this.isExpand?p(this,this.leftOverflow):p(this,d-g-this.rightOverflow)}})}},28:{value:function(){var b=e.r(21),c=e.r(4),h=e.r(22),a=e.r(14),f=e.r(23).VIEW_STATE,d=e.r(27);return b.createClass("UIComponent",{constructor:function(b,d){var c=null;this.options=d;this.lastHeight=-1;this.minHeight-1;this.notifyCallback=null;this.container=b.getContainer();c=this.container.ownerDocument;this.components=
{};this.canvasRect=null;this.viewState=f.NO_OVERFLOW;this.latexInput=null;this.kfEditor=b;this.toolbarWidget=a.Creator.parse(h);this.editArea=new a.Panel({className:"kf-editor-ui-editor-area"});this.canvasContainer=new a.Panel({className:"kf-editor-ui-canvas"});this.scrollbarContainer=new a.Panel({className:"kf-editor-edit-scrollbar"});this.latexArea=new a.Panel({className:"kf-editor-ui-latex-area"});var e=c.createElement("textarea");e.className="kf-editor-latex-input";this.latexInput=e;this.latexArea.getContentElement().appendChild(this.latexInput);
c=c.createElement("div");c.className="kf-editor-edit-scrollbar";this.scrollbarContainer=c;this.toolbarWidget.appendTo(this.container);this.canvasContainer.appendTo(this.editArea);this.latexArea.appendTo(this.editArea);this.editArea.appendTo(this.container);this.container.appendChild(this.scrollbarContainer);this.canvasContainer=this.canvasContainer.getContentElement();this.editArea=this.editArea.getContentElement();this.initComponents();this.initServices();this.initCommands();this.initEvent();this.updateContainerSize(this.container,
this.toolbarWidget.getContentElement(),this.editArea);this.initScrollEvent()},initComponents:function(){this.components.scrollbar=new d(this,this.kfEditor)},updateContainerSize:function(a,b,d){a=a.getBoundingClientRect();b=b.getBoundingClientRect();b=a.bottom-b.bottom;d.style.width=a.width+"px";d.style.height=b+"px";this.minHeight=this.lastHeight=b;this.canvasContainer.style.height=this.lastHeight+"px"},updateCanvasSize:function(){var a=-1,a=-1,a=this.kfEditor.requestService("syntax.get.root").getRenderBox("paper").height;
a<this.lastHeight?a<this.lastHeight&&(a=this.lastHeight-Math.max(a,this.minHeight),a=Math.floor(a/100),0!==a&&this.updateHeight(100*-a)):this.updateHeight(100*Math.ceil((a-this.lastHeight)/100))},updateHeight:function(a){this.lastHeight+=a;this.canvasContainer.style.height=this.lastHeight+"px";this.editArea.style.height=this.lastHeight+"px";this.container.style.height=$(this.container).height()+a+"px";this.notifyContainer(a)},notifyContainer:function(a){this.notifyCallback&&this.notifyCallback(a)},
setNotify:function(a){this.notifyCallback=a},initServices:function(){this.kfEditor.registerService("ui.get.canvas.container",this,{getCanvasContainer:this.getCanvasContainer});this.kfEditor.registerService("ui.get.latex.input",this,{getLatexInput:this.getLatexInput});this.kfEditor.registerService("ui.update.canvas.view",this,{updateCanvasView:this.updateCanvasView});this.kfEditor.registerService("ui.canvas.container.event",this,{on:this.addEvent,off:this.removeEvent,trigger:this.trigger,fire:this.trigger});
this.kfEditor.registerService("ui.update.canvas.size",this,{updateCanvasSize:this.updateCanvasSize});this.kfEditor.registerService("ui.toolbar.disable",this,{disableToolbar:this.disableToolbar});this.kfEditor.registerService("ui.toolbar.enable",this,{enableToolbar:this.enableToolbar});this.kfEditor.registerService("ui.toolbar.close",this,{closeToolbar:this.closeToolbar})},initCommands:function(){this.kfEditor.registerCommand("resize.notify",this,this.setNotify)},initEvent:function(){var a=this.kfEditor;
c.addEvent(this.container,"mousewheel",function(a){a.preventDefault()});this.toolbarWidget.on("btnclick",function(b){(b=b.widget.getValue())&&a.requestService("control.insert.string",b)})},initScrollEvent:function(){var a=this;this.kfEditor.requestService("ui.set.scrollbar.update.handler",function(b,d,f){d=Math.floor(b*(f.contentWidth-f.viewWidth));a.kfEditor.requestService("render.set.canvas.offset",d)})},getCanvasContainer:function(){return this.canvasContainer},addEvent:function(a,b){c.addEvent(this.canvasContainer,
a,b)},removeEvent:function(){},trigger:function(a){c.trigger(this.canvasContainer,a)},getLatexInput:function(){return this.latexInput},updateCanvasView:function(){var a=this.kfEditor.requestService("render.get.canvas").getContentContainer(),b=null;null===this.canvasRect&&(this.canvasRect=this.canvasContainer.getBoundingClientRect());b=a.getRenderBox("paper");b.width>this.canvasRect.width?(this.viewState===f.NO_OVERFLOW&&(this.toggleViewState(),this.kfEditor.requestService("ui.show.scrollbar"),this.kfEditor.requestService("render.disable.relocation")),
this.kfEditor.requestService("render.relocation"),this.kfEditor.requestService("ui.update.scrollbar",b.width),this.kfEditor.requestService("ui.relocation.scrollbar")):(this.viewState===f.OVERFLOW&&(this.toggleViewState(),this.kfEditor.requestService("ui.hide.scrollbar"),this.kfEditor.requestService("render.enable.relocation")),this.kfEditor.requestService("render.relocation"));this.updateCanvasSize()},toggleViewState:function(){this.viewState=this.viewState===f.NO_OVERFLOW?f.OVERFLOW:f.NO_OVERFLOW},
disableToolbar:function(){},enableToolbar:function(){},closeToolbar:function(){}})}},29:{value:function(){function b(a,i,e){var h=null,o=!e;i.attr=i.attr||{};i.attr.id=a.getGroupId();if(o)a.isResetId?i.attr["data-root"]="true":i.attr["data-type"]=p.VIRTUAL;else{if(o=e.attr["data-root"])if(o="placeholder"===i.name)if(e=e.operand,o=e.length,3<o)o=!1;else{for(var h=0,s=e.length;h<s;h++)(e[h]===f||"placeholder"===e[h].name)&&o--;o=!o}o&&(i.attr.label=g)}e=0;for(o=i.operand.length;e<o;e++)if(h=i.operand[e],
d[i.name]){var s=a,r=e,m=i;!("brackets"===m.name&&2>r)&&!("function"===m.name&&0===r)&&(m.attr["data-type"]=p.VIRTUAL,h?"string"===typeof h?(m.operand[r]=c(s),m.operand[r].operand[0]=h):"placeholder"===h.name?(m.operand[r]=c(s),m.operand[r].operand[0]=b(s,h,m.operand[r])):m.operand[r]=b(s,h,m):m.operand[r]=h)}else s=a,r=e,m=i,m.attr["data-type"]=p.GROUP,m.operand[r]=!h||"string"===typeof h?h:"text"===h.name?h:b(s,h,m);return i}function c(a){return{name:i,attr:{"data-type":p.GROUP,id:a.getGroupId()},
operand:[]}}var h=e.r(20).Parser,a=e.r(21),f=e.r(37).cursorCharacter,d=e.r(30),g=e.r(37).rootPlaceholder.content,i="combination",p=e.r(11),k=0;return a.createClass("Parser",{constructor:function(a){this.kfEditor=a;this.callBase();this.kfParser=h.use("latex");this.initKFormulExtension();this.pid="_kf_editor_"+ ++k;this.groupRecord=0;this.tree=null;this.isResetId=!0;this.initServices()},parse:function(a,d){var f=null;(this.isResetId=!!d)&&this.resetGroupId();f=this.kfParser.parse(a);b(this,f.tree);
return f},serialization:function(a){return this.kfParser.serialization(a)},initServices:function(){this.kfEditor.registerService("parser.parse",this,{parse:this.parse});this.kfEditor.registerService("parser.latex.serialization",this,{serialization:this.serialization})},getKFParser:function(){return this.kfParser},initKFormulExtension:function(){e.r(18).ext(this)},resetGroupId:function(){this.groupRecord=0},getGroupId:function(){return this.pid+"_"+ ++this.groupRecord}})}},30:{value:function(){return{radical:!0,
fraction:!0,summation:!0,integration:!0,placeholder:!0,script:!0,superscript:!0,subscript:!0,brackets:!0,"function":!0,cases:!0,split:!0,mathcal:!0,overparen:!0,underbrace:!0,mathfrak:!0,mathbf:!0,mathbb:!0,mathrm:!0,hat:!0,vec:!0,overrightarrow:!0,widehat:!0,vmatrix:!0,pmatrix:!0,textcircled:!0,product:!0,pmod:!0,overline:!0}}},31:{value:function(){function b(a,f,d){var g=null;if(!a.ownerSVGElement)return null;a=a.parentNode;g=a.tagName.toLowerCase();return a&&"body"!==g&&"svg"!==g?"kf-editor-group"===
a.getAttribute("data-type")||f&&"kf-editor-virtual-group"===a.getAttribute("data-type")||d&&null!==a.getAttribute("data-flag")?a:b(a,f,d):null}var c=e.r(21),h=e.r(4);return c.createClass("PositionComponenet",{constructor:function(a){this.kfEditor=a;this.initServices()},initServices:function(){this.kfEditor.registerService("position.get.group",this,{getGroupByTarget:this.getGroupByTarget});this.kfEditor.registerService("position.get.index",this,{getIndexByTargetInGroup:this.getIndexByTargetInGroup});
this.kfEditor.registerService("position.get.location.info",this,{getLocationInfo:this.getLocationInfo});this.kfEditor.registerService("position.get.parent.group",this,{getParentGroupByTarget:this.getParentGroupByTarget});this.kfEditor.registerService("position.get.wrap",this,{getWrap:this.getWrap});this.kfEditor.registerService("position.get.area",this,{getAreaByCursorInGroup:this.getAreaByCursorInGroup});this.kfEditor.registerService("position.get.group.info",this,{getGroupInfoByNode:this.getGroupInfoByNode});
this.kfEditor.registerService("position.get.parent.info",this,{getParentInfoByNode:this.getParentInfoByNode})},getGroupByTarget:function(a){return(a=b(a,!1,!1))?this.kfEditor.requestService("syntax.get.group.content",a.id):null},getIndexByTargetInGroup:function(a,b){var d=this.kfEditor.requestService("syntax.get.group.content",a.id),g=-1;c.Utils.each(d.content,function(a,d){g=d;if(h.contains(a,b))return!1});return g},getAreaByCursorInGroup:function(a,b){var d=h.getRect(a);return d.left+d.width/2<
b},getLocationInfo:function(a,b){for(var d=-1,g=b.content,c=null,e=g.length-1,c=null;0<=e;e--)if(d=e,c=g[e],c=h.getRect(c),c.left<a){c.left+c.width/2<a&&(d+=1);break}return d},getParentGroupByTarget:function(a){return(a=b(a,!0,!1))?this.kfEditor.requestService("syntax.get.group.content",a.id):null},getWrap:function(a){return b(a,!0,!0)},getGroupInfoByNode:function(a){var f={},d=b(a,!1,!1),g=null;if(!d)return null;for(var g=this.kfEditor.requestService("syntax.get.group.content",d.id),d=0,c=g.content.length;d<
c&&!(f.index=d,h.contains(g.content[d],a));d++);f.group=g;return f},getParentInfoByNode:function(a){var f=b(a,!0,!1),f=this.kfEditor.requestService("syntax.get.group.content",f.id);return{group:f,index:f.content.indexOf(a)}}})}},32:{value:function(){return e.r(21).createClass("Printer",{constructor:function(b){this.kfEditor=b;this.initServices();this.initCommands()},initServices:function(){this.kfEditor.registerService("print.image",this,{printImage:this.printImage})},initCommands:function(){this.kfEditor.registerCommand("get.image.data",
this,this.getImageData)},printImage:function(){var b=this.kfEditor.requestService("render.get.paper");this._formatCanvas();b.toPNG(function(b){document.body.innerHTML='<img style="background: red;" src="'+b+'">'});this._restoreCanvas()},getImageData:function(b){var c=this.kfEditor.requestService("render.get.canvas"),e=this.kfEditor.requestService("render.get.paper");this._formatCanvas();e.toPNG(function(a){b({width:c.width,height:c.height,img:a})});this._restoreCanvas()},_formatCanvas:function(){var b=
this.kfEditor.requestService("render.get.canvas"),c=b.container.getRenderBox();b.node.setAttribute("width",c.width);b.node.setAttribute("height",c.height);this.kfEditor.requestService("render.clear.canvas.transform");this.kfEditor.requestService("control.cursor.hide");this.kfEditor.requestService("render.clear.select")},_restoreCanvas:function(){var b=this.kfEditor.requestService("render.get.canvas");b.node.setAttribute("width","100%");b.node.setAttribute("height","100%");this.kfEditor.requestService("render.revert.canvas.transform");
this.kfEditor.requestService("control.cursor.relocation");this.kfEditor.requestService("render.reselect")}})}},33:{value:function(){var b=e.r(21),c=e.r(20).Assembly,h={autoresize:!1,fontsize:50,padding:[20,50]};return b.createClass("RenderComponent",{base:e.r(1),constructor:function(a,f){this.callBase();this.options=b.Utils.extend({},h,f);this.kfEditor=a;this.formula=this.assembly=null;this.__cbList=[];this.relDisabled=!1;this.canvasZoom=1;this.record={select:{},cursor:{},canvas:{}};this.initCanvas();
this.initServices();this.initCommands()},initCanvas:function(){var a=this.kfEditor.requestService("ui.get.canvas.container"),b=this.kfEditor.getFormulaClass();this.assembly=new c(new b(a,this.options));this.formula=this.assembly.formula;this.setCanvasToCenter()},setCanvasOffset:function(a,b){var d=this.formula.getViewBox(),b=void 0!==b?b:-d.height/2;this.formula.setViewBox(a,b,d.width,d.height)},setCanvasToCenter:function(){var a=this.formula.getViewBox();this.formula.setViewBox(-a.width/2,-a.height/
2,a.width,a.height)},initServices:function(){this.kfEditor.registerService("render.get.canvas",this,{getCanvas:this.getCanvas});this.kfEditor.registerService("render.get.content.size",this,{getContentSize:this.getContentSize});this.kfEditor.registerService("render.clear.canvas.transform",this,{clearCanvasOffset:this.clearCanvasTransform});this.kfEditor.registerService("render.set.canvas.offset",this,{setCanvasOffset:this.setCanvasOffset});this.kfEditor.registerService("render.set.canvas.to.center",
this,{setCanvasToCenter:this.setCanvasToCenter});this.kfEditor.registerService("render.revert.canvas.transform",this,{revertCanvasTransform:this.revertCanvasTransform});this.kfEditor.registerService("render.relocation",this,{relocation:this.relocation});this.kfEditor.registerService("render.disable.relocation",this,{disableRelocation:this.disableRelocation});this.kfEditor.registerService("render.enable.relocation",this,{enableRelocation:this.enableRelocation});this.kfEditor.registerService("render.select.group.content",
this,{selectGroupContent:this.selectGroupContent});this.kfEditor.registerService("render.select.group",this,{selectGroup:this.selectGroup});this.kfEditor.registerService("render.select.group.all",this,{selectAllGroup:this.selectAllGroup});this.kfEditor.registerService("render.tint.current.cursor",this,{tintCurrentGroup:this.tintCurrentGroup});this.kfEditor.registerService("render.select.current.cursor",this,{selectCurrentCursor:this.selectCurrentCursor});this.kfEditor.registerService("render.reselect",
this,{reselect:this.reselect});this.kfEditor.registerService("render.clear.select",this,{clearSelect:this.clearSelect});this.kfEditor.registerService("render.set.canvas.zoom",this,{setCanvasZoom:this.setCanvasZoom});this.kfEditor.registerService("render.get.canvas.zoom",this,{getCanvasZoom:this.getCanvasZoom});this.kfEditor.registerService("render.get.paper.offset",this,{getPaperOffset:this.getPaperOffset});this.kfEditor.registerService("render.draw",this,{render:this.render});this.kfEditor.registerService("render.insert.string",
this,{insertString:this.insertString});this.kfEditor.registerService("render.insert.group",this,{insertGroup:this.insertGroup});this.kfEditor.registerService("render.get.paper",this,{getPaper:this.getPaper})},initCommands:function(){this.kfEditor.registerCommand("render",this,function(a){this.render(a);this.kfEditor.requestService("control.set.source",a);this.kfEditor.requestService("ui.update.canvas.view")});this.kfEditor.registerCommand("register.render.listener",this,this.registerListener);this.kfEditor.registerCommand("getPaper",
this,this.getPaper)},relocation:function(){this.relDisabled?this.relocationToLeft():this.relocationToCenter()},relocationToCenter:function(){var a=this.formula.container.getRenderBox();this.formula.container.setTranslate(-a.width/2,-a.height/2);this.setCanvasToCenter()},relocationToLeft:function(){this.formula.container.setTranslate(0,-this.formula.container.getRenderBox().height/2);this.setCanvasOffset(0)},registerListener:function(a){this.__cbList.push(a)},selectGroup:function(a){a=this.kfEditor.requestService("syntax.get.group.object",
a);this.clearSelect();a.node.getAttribute("data-root")||(this.record.select.lastSelect=a,a.select())},selectGroupContent:function(a){null!==a.groupObj.getAttribute("data-placeholder")&&(a={id:a.content[0].id});a=this.kfEditor.requestService("syntax.get.group.object",a.id);this.clearSelect();this.record.select.lastSelect=a;a.node.getAttribute("data-root")||a.select()},selectAllGroup:function(a){null!==a.groupObj.getAttribute("data-placeholder")&&(a={id:a.content[0].id});a=this.kfEditor.requestService("syntax.get.group.object",
a.id);this.clearSelect();this.record.select.lastSelect=a;a.selectAll()},selectCurrentCursor:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor"),b=this.kfEditor.requestService("syntax.get.group.object",a.groupId),d=null,g=-1,c=0,d=Math.min(a.startOffset,a.endOffset),a=Math.max(a.startOffset,a.endOffset);this.clearSelect();this.record.select.lastSelect=b;for(var e=d;e<a;e++)d=b.getOperand(e).getRenderBox(b),-1==g&&(g=d.x),c+=d.width;b.setBoxWidth(c);b.selectAll();b.getBox().setTranslate(g,
0)},tintCurrentGroup:function(){var a=this.kfEditor.requestService("syntax.get.record.cursor").groupId,b=this.kfEditor.requestService("syntax.get.group.object",a),a=this.kfEditor.requestService("syntax.is.placeholder.node",a);this.clearSelect();b.node.getAttribute("data-root")||(a&&(b=this.kfEditor.requestService("syntax.get.group.object",b.operands[0].node.id)),this.record.select.lastSelect=b,b.select())},reselect:function(){var a=null,a=this.kfEditor.requestService("syntax.get.group.object",this.kfEditor.requestService("syntax.get.record.cursor").groupId);
this.clearSelect();this.record.select.lastSelect=a;a.node.getAttribute("data-root")||a.select()},clearSelect:function(){var a=null,b=this.record.select.lastSelect;b&&b.node.ownerSVGElement&&(b.unselect(),a=b.getRenderBox(b),b.setBoxWidth(a.width),b.getBox().setTranslate(0,0))},getPaper:function(){return this.formula},render:function(a){this.kfEditor.requestService("syntax.update.objtree",this.assembly.regenerateBy(this.kfEditor.requestService("parser.parse",a,!0)))},enableRelocation:function(){this.relDisabled=
!1},disableRelocation:function(){this.relDisabled=!0},setCanvasZoom:function(a){var b=this.formula.getViewPort();this.canvasZoom=a;b.zoom=a;this.formula.setViewPort(b)},getCanvas:function(){return this.formula},getContentSize:function(){return this.formula.container.getRenderBox()},clearCanvasTransform:function(){var a=this.record.canvas;a.viewBox=this.formula.getViewBox();a.contentOffset=this.formula.container.getTranslate();this.setCanvasToCenter();this.formula.node.removeAttribute("viewBox");this.formula.container.setTranslate(0,
0)},revertCanvasTransform:function(){var a=this.record.canvas,b=a.viewBox;if(!b)return!1;this.formula.setViewBox(b.x,b.y,b.width,b.height);this.formula.container.setTranslate(a.contentOffset);a.viewBox=null;a.contentOffset=null},getCanvasZoom:function(){return this.canvasZoom}})}},34:{value:function(){return e.r(21).createClass("DeleteComponent",{constructor:function(b,c){this.parentComponent=b;this.kfEditor=c},deleteGroup:function(){var b=this.parentComponent.getCursorRecord(),c=this.parentComponent.getObjectTree(),
e=c.mapping[b.groupId].strGroup;if(b.startOffset===b.endOffset){if(0===b.startOffset){if(this.parentComponent.isRootTree(e))return!1;b=this.selectParentContainer(b.groupId);this.parentComponent.updateCursor(b);return!1}if(1<e.operand.length)b=this.deletePrevGroup(e,b);else{b.startOffset=0;b.endOffset=1;if(e.operand[0].attr&&this.parentComponent.isGroupNode(e.operand[0].attr.id))return this.parentComponent.updateCursor(b),!1;e.operand[0]={name:"placeholder",operand:[]};this.parentComponent.updateCursor(b);
return!0}}else{if(this.parentComponent.isSelectPlaceholder())return this.parentComponent.isRootTree(e)||(b=this.selectParentContainer(b.groupId),this.parentComponent.updateCursor(b)),!1;var a=this.selectParentContainer(b.groupId),f=!1,d=null,c=c.mapping[a.groupId].strGroup;if("cases"===c.name){for(d=c.operand[a.startOffset];d.operand&&0<d.operand.length&&!(f="placeholder"===d.operand[0].name);)d=d.operand[0];if(f){if(1===c.operand.length)return a=this.selectParentContainer(b.groupId),a=this.selectParentContainer(a.groupId),
this.parentComponent.updateCursor(a),!1;c.operand.splice(a.startOffset,1);0<a.startOffset&&(a.startOffset-=1,a.endOffset-=1);this.parentComponent.updateCursor(a);return!0}}return this.deleteSelection(e,b)}this.parentComponent.updateCursor(b);return b.startOffset===b.endOffset?!0:!1},deletePrevGroup:function(b,c){var e=c.startOffset-1;this.parentComponent.isLeafTree(b.operand[e])?(b.operand.splice(e,1),c.startOffset-=1,c.endOffset-=1):c.startOffset-=1;return c},deleteSelection:function(b,c){0===c.startOffset&&
c.endOffset===b.operand.length?(b.operand.length=1,b.operand[0]={name:"placeholder",operand:[]},c.endOffset=1):(b.operand.splice(c.startOffset,c.endOffset-c.startOffset),c.endOffset=c.startOffset);this.parentComponent.updateCursor(c);return!0},selectParentContainer:function(b){if(this.parentComponent.isRootNode(b))return this.parentComponent.getCursorRecord();var c=this.parentComponent.getGroupObject(b).node,b=this.kfEditor.requestService("position.get.group",c),c=this.kfEditor.requestService("position.get.index",
b.groupObj,c);return{groupId:b.id,startOffset:c,endOffset:c+1}}})}},35:{value:function(){var b,c;function h(a,d,e){switch(e){case b:return f(a,d);case c:return g(a,d)}throw Error("undefined move direction!");}function a(a,g,f){switch(f){case b:return d(a,g);case c:return i(a,g)}throw Error("undefined move direction!");}function f(a,b){var g=a.parentComponent,c=null,e=null;if(j(b)||l(b))return d(a,b);if(n(b)){c=g.getGroupContent(b.id);e=c.content[c.content.length-1];if(l(e))return d(a,e);if(k(b))return j(e)?
{groupId:b.id,startOffset:c.content.length-1,endOffset:c.content.length}:k(e)&&1<=c.content.length?f(a,e):{groupId:b.id,startOffset:c.content.length,endOffset:c.content.length};for(;!k(e)&&!l(e)&&!j(e);)c=g.getGroupContent(e.id),e=c.content[c.content.length-1];return l(e)?d(a,e):j(e)?{groupId:e.id,startOffset:c.content.length,endOffset:c.content.length}:f(a,e)}return null}function d(a,b){var g=a.kfEditor,c=null;if(p(b))return null;for(c=g.requestService("position.get.parent.info",b);0===c.index;){if(p(c.group.groupObj)||
k(c.group.groupObj)&&1<c.group.content.length&&0!==c.index)return{groupId:c.group.id,startOffset:0,endOffset:0};if(n(c.group.groupObj)&&q(c.group.groupObj))return c=g.requestService("position.get.parent.info",c.group.groupObj),{groupId:c.group.id,startOffset:c.index,endOffset:c.index};c=g.requestService("position.get.parent.info",c.group.groupObj)}if(k(c.group.groupObj))return g=c.group.content[c.index-1],k(g)?f(a,g):{groupId:c.group.id,startOffset:c.index,endOffset:c.index};b=c.group.content[c.index-
1];return n(b)?(k(b),f(a,b)):l(b)?d(a,b):{groupId:c.group.id,startOffset:c.index,endOffset:c.index}}function g(a,b){var d=a.parentComponent,c=null,c=null;if(n(b)){c=d.getGroupContent(b.id);c=c.content[0];if(k(b))return k(c)?g(a,c):j(c)?{groupId:b.id,startOffset:0,endOffset:1}:{groupId:b.id,startOffset:0,endOffset:0};for(;!k(c)&&!j(c)&&!l(c);)c=d.getGroupContent(c.id),c=c.content[0];return j(c)?{groupId:c.id,startOffset:0,endOffset:0}:l(c)?i(a,c):g(a,c)}return null}function i(a,b){var d=a.kfEditor,
c=a.parentComponent,e=null,e=null;if(p(b))return null;for(e=d.requestService("position.get.parent.info",b);e.index===e.group.content.length-1;){if(p(e.group.groupObj))return{groupId:e.group.id,startOffset:e.group.content.length,endOffset:e.group.content.length};if(n(e.group.groupObj)&&q(e.group.groupObj))return e=d.requestService("position.get.parent.info",e.group.groupObj),{groupId:e.group.id,startOffset:e.index+1,endOffset:e.index+1};if(k(e.group.groupObj)&&1<e.group.content.length&&e.index<e.group.content.length)return{groupId:e.group.id,
startOffset:e.index+1,endOffset:e.index+1};e=d.requestService("position.get.parent.info",e.group.groupObj)}b=e.group.content[e.index+1];return l(b)?i(a,b,!0):k(b)?(e=c.getGroupContent(b.id),c.isPlaceholder(e.content[0].id)?{groupId:b.id,startOffset:0,endOffset:1}:g(a,b)):{groupId:e.group.id,startOffset:e.index+1,endOffset:e.index+1}}function p(a){return!!a.getAttribute("data-root")}function k(a){return"kf-editor-group"===a.getAttribute("data-type")}function n(a){a=a.getAttribute("data-type");return"kf-editor-group"===
a||"kf-editor-virtual-group"===a}function q(a){return"combination"!==a.getAttribute("data-flag").toLocaleLowerCase()}function j(a){return"Placeholder"===a.getAttribute("data-flag")}function l(a){return"Empty"===a.getAttribute("data-flag")}b="left";c="right";return e.r(21).createClass("MoveComponent",{constructor:function(a,b){this.parentComponent=a;this.kfEditor=b},leftMove:function(){var d=this.parentComponent.getCursorRecord();var c=null,c=this.parentComponent,g=null,g=c.getGroupContent(d.groupId);
c.isSelectPlaceholder()?d=a(this,g.content[d.startOffset],b):d.startOffset===d.endOffset?0<d.startOffset?(c=g.content[d.startOffset-1],n(c)?d=h(this,c,b):(d.startOffset-=1,j(c)||(d.endOffset=d.startOffset))):d=a(this,g.groupObj,b):(d.startOffset=Math.min(d.startOffset,d.endOffset),d.endOffset=d.startOffset);d&&this.parentComponent.updateCursor(d)},rightMove:function(){var b=this.parentComponent.getCursorRecord();var d=null,d=this.parentComponent,g=null,g=d.getGroupContent(b.groupId);d.isSelectPlaceholder()?
b=a(this,g.content[b.startOffset],c):b.startOffset===b.endOffset?b.startOffset<g.content.length?(d=g.content[b.startOffset],n(d)?b=h(this,d,c):(b.startOffset+=1,j(d)||(b.endOffset=b.startOffset))):b=a(this,g.groupObj,c):(b.endOffset=Math.max(b.startOffset,b.endOffset),b.startOffset=b.endOffset);b&&this.parentComponent.updateCursor(b)}})}},36:{value:function(){var b=e.r(21),c=e.r(35),h=e.r(34),a=e.r(37).cursorCharacter,f=e.r(11);return b.createClass("SyntaxComponenet",{constructor:function(a){this.kfEditor=
a;this.record={cursor:{group:null,startOffset:-1,endOffset:-1}};this.components={};this.objTree=null;this.initComponents();this.initServices();this.initCommands()},initComponents:function(){this.components.move=new c(this,this.kfEditor);this.components.deleteComp=new h(this,this.kfEditor)},initServices:function(){this.kfEditor.registerService("syntax.update.objtree",this,{updateObjTree:this.updateObjTree});this.kfEditor.registerService("syntax.get.objtree",this,{getObjectTree:this.getObjectTree});
this.kfEditor.registerService("syntax.get.group.object",this,{getGroupObject:this.getGroupObject});this.kfEditor.registerService("syntax.is.root.node",this,{isRootNode:this.isRootNode});this.kfEditor.registerService("syntax.is.group.node",this,{isGroupNode:this.isGroupNode});this.kfEditor.registerService("syntax.is.virtual.node",this,{isVirtualNode:this.isVirtualNode});this.kfEditor.registerService("syntax.is.placeholder.node",this,{isPlaceholder:this.isPlaceholder});this.kfEditor.registerService("syntax.is.select.placeholder",
this,{isSelectPlaceholder:this.isSelectPlaceholder});this.kfEditor.registerService("syntax.has.root.placeholder",this,{hasRootplaceholder:this.hasRootplaceholder});this.kfEditor.registerService("syntax.valid.brackets",this,{isBrackets:this.isBrackets});this.kfEditor.registerService("syntax.get.group.content",this,{getGroupContent:this.getGroupContent});this.kfEditor.registerService("syntax.get.root.group.info",this,{getRootGroupInfo:this.getRootGroupInfo});this.kfEditor.registerService("syntax.get.root",
this,{getRootObject:this.getRootObject});this.kfEditor.registerService("syntax.update.record.cursor",this,{updateCursor:this.updateCursor});this.kfEditor.registerService("syntax.update.selection",this,{updateSelection:this.updateSelection});this.kfEditor.registerService("syntax.get.record.cursor",this,{getCursorRecord:this.getCursorRecord});this.kfEditor.registerService("syntax.has.cursor.info",this,{hasCursorInfo:this.hasCursorInfo});this.kfEditor.registerService("syntax.serialization",this,{serialization:this.serialization});
this.kfEditor.registerService("syntax.cursor.move.left",this,{leftMove:this.leftMove});this.kfEditor.registerService("syntax.cursor.move.right",this,{rightMove:this.rightMove});this.kfEditor.registerService("syntax.delete.group",this,{deleteGroup:this.deleteGroup})},initCommands:function(){this.kfEditor.registerCommand("get.source",this,this.getSource);this.kfEditor.registerCommand("content.is.empty",this,this.isEmpty)},updateObjTree:function(a){var b=a.select;b&&b.groupId&&this.updateCursor(b.groupId,
b.startOffset,b.endOffset);this.objTree=a},hasCursorInfo:function(){return null!==this.record.cursor.group},isRootNode:function(a){return this.objTree.mapping.root.strGroup.attr.id===a},isGroupNode:function(a){a=this.objTree.mapping[a].strGroup.attr["data-type"];return a===f.GROUP||a===f.VIRTUAL},isVirtualNode:function(a){return this.objTree.mapping[a].strGroup.attr["data-type"]===f.VIRTUAL},isPlaceholder:function(a){a=this.objTree.mapping[a];if(!a)return!1;a=a.objGroup.node;return"Placeholder"===
a.getAttribute("data-flag")},isBrackets:function(a){return!!this.objTree.mapping[a].objGroup.node.getAttribute("data-brackets")},hasRootplaceholder:function(){return"placeholder"===this.objTree.mapping.root.strGroup.operand[0].name},isSelectPlaceholder:function(){var a=this.record.cursor,b=null;if(1!==a.endOffset-a.startOffset)return!1;b=this.getGroupContent(a.groupId);return!this.isPlaceholder(b.content[a.startOffset].id)?!1:!0},isLeafTree:function(a){return"string"===typeof a},isRootTree:function(a){return a.attr&&
a.attr["data-root"]},getObjectTree:function(){return this.objTree},getGroupObject:function(a){return this.objTree.mapping[a].objGroup||null},getCursorRecord:function(){return b.Utils.extend({},this.record.cursor)||null},getGroupContent:function(a){var c=this.objTree.mapping[a],e=[],f=c.objGroup.operands,h=f.length-1,n="rtl"!==c.strGroup.traversal;b.Utils.each(f,function(a,b){n?e.push(a.node):e[h-b]=a.node});return{id:a,traversal:c.strGroup.traversal||"ltr",groupObj:c.objGroup.node,content:e}},getRootObject:function(){return this.objTree.mapping.root.objGroup},
getRootGroupInfo:function(){return this.getGroupContent(this.objTree.mapping.root.strGroup.attr.id)},updateSelection:function(b){var c=this.objTree.mapping[b.id],e=c.strGroup,f=null,h=null,f=null,n=-1,q=-1,f=b,h=c;if("combination"===e.name)this.record.cursor={groupId:f.id,startOffset:0,endOffset:e.operand.length},e.operand.unshift(a),e.operand.push(a);else{for(;"combination"!==h.strGroup.name||1===f.content;)b=f,c=h,f=this.kfEditor.requestService("position.get.parent.group",c.objGroup.node),h=this.objTree.mapping[f.id];
b=[].indexOf.call(f.content,b.groupObj);this.record.cursor={groupId:f.id,startOffset:b,endOffset:b+1};h.strGroup.operand.splice(b+1,0,a);h.strGroup.operand.splice(b,0,a)}f=this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree);n=f.indexOf(a);f=f.replace(a,"");q=f.indexOf(a);h.strGroup.operand.splice(this.record.cursor.startOffset,1);h.strGroup.operand.splice(this.record.cursor.endOffset,1);return{str:f,startOffset:n,endOffset:q}},getSource:function(){return this.serialization().str.replace(a,
"").replace(a,"")},isEmpty:function(){return this.hasRootplaceholder()},serialization:function(){var b=this.record.cursor,c=this.objTree.mapping[b.groupId].strGroup,e=null,f=-1,h=-1,f=Math.min(b.endOffset,b.startOffset),h=Math.max(b.endOffset,b.startOffset);c.operand.splice(h,0,a);c.operand.splice(f,0,a);h+=1;e=this.kfEditor.requestService("parser.latex.serialization",this.objTree.parsedTree);c.operand.splice(h,1);c.operand.splice(f,1);f=e.indexOf(a);b.startOffset===b.endOffset&&(e=e.replace(a,""));
h=e.lastIndexOf(a);return{str:e,startOffset:f,endOffset:h}},updateCursor:function(a,b,c){var e=null;1===arguments.length&&(c=a.endOffset,b=a.startOffset,a=a.groupId);void 0===c&&(c=b);b>c&&(e=c,c=b,b=e);this.record.cursor={groupId:a,startOffset:b,endOffset:c}},leftMove:function(){this.components.move.leftMove()},rightMove:function(){this.components.move.rightMove()},deleteGroup:function(){return this.components.deleteComp.deleteGroup()},insertSubtree:function(a){var b=this.record.cursor,c=0,e=0,f=
null;this.isPlaceholder(b.groupId)?this.replaceTree(a):(c=Math.min(b.startOffset,b.endOffset),e=Math.max(b.startOffset,b.endOffset),f=this.objTree.mapping[b.groupId].strGroup,f.operand.splice(c,e-c,a),b.startOffset+=1,b.endOffset=b.startOffset)},replaceTree:function(a){var b=this.record.cursor,c=this.kfEditor.requestService("position.get.parent.info",this.objTree.mapping[b.groupId].objGroup.node);this.objTree.mapping[c.group.id].strGroup.operand[c.index]=a;b.groupId=c.group.id;b.startOffset=c.index+
1;b.endOffset=c.index+1}})}},37:{value:function(){return{cursorCharacter:"",rootPlaceholder:{color:"#666",content:"在此处键入公式",fontsize:16},scrollbar:{padding:5,step:150},enableLatex:!0}}},38:{value:function(){var b=e.r(12),c=e.r(13);b.registerComponents("ui",e.r(28));b.registerComponents("parser",e.r(29));b.registerComponents("render",e.r(33));b.registerComponents("position",e.r(31));b.registerComponents("syntax",e.r(36));b.registerComponents("control",e.r(5));b.registerComponents("print",e.r(32));
kf.EditorFactory=c}}},t={"kf.start":38};try{e.r([t["kf.start"]])}catch(u){}})();